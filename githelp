#!/usr/bin/env ruby
# coding: utf-8
#
# GitHelp: ExpandHelpでGitを使いこなす
#
#  % githelp README 3 変化
#  [0] README.mdというファイルの3日前からの変化を表示する
#   git log --since="3 days ago" --oneline | tail -1 | ruby -lane 'puts $_.split(/ /).first' | xargs -J xxx git diff xxx README.md
#  %
#

require 're_expand'
require './lib/files'
require './lib/args'
require './lib/params'
require './lib/branches'

datadir = "#{File.dirname($0)}/data"

#args = ARGV.map { |arg|
#  arg.sub(/^['"]/,'').sub(/['"]$/,'')
#}
pat = " #{args.join(' ')} "

entries = []
Dir.open(datadir).each { |file|
  next unless File.file?("#{datadir}/#{file}")
  next if file !~ /\.rb$/
  a = eval File.read("#{datadir}/#{file}")
  entries += a if a
}

g = ExpandRuby::Generator.new # re_expandのジェネレータ
entries.each { |entry|
  g.add entry[0], entry[1]
}

list = []
ind = 0
res = g.generate pat
res[0].each { |a| # ambig 0
  unless list.member?(a[1])
    puts "[#{ind}] #{a[0]}"
    puts a[1]
    list[ind] = a[1]
    ind += 1
  end
}

print "実行するコマンドの番号を入力して下さい > "
s = STDIN.readline
if s =~ /[0-9]/ then
  i = s.to_i
  if i >= 0 && i < list.length then
    puts list[i]
    print "実行しますか? > "
    s = STDIN.readline
    if s =~ /^y/i then
      system list[i]
    end
  end
end



